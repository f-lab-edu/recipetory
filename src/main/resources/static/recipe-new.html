<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë ˆì‹œí”¼í† ë¦¬</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body class="d-flex flex-column min-vh-100">
    <header class="text-center p-4" style="background-color: #d1e7dc">
      <h1 class="display-4">
        <img
          width="60"
          height="60"
          src="/view/logo.png"
          alt="external-Salad-international-food-goofy-flat-kerismaker"
        />
        <a href="/" style="color: black; text-decoration: none">RECIPETORY</a>
      </h1>
      <p class="lead">ë§›ìˆëŠ” ë ˆì‹œí”¼ë¥¼ ê³µìœ í•˜ê³  ì¦ê¸°ì„¸ìš”!</p>
      <div class="row justify-content-center">
        <div class="col-md-8">
          <form id="recipe-serach-form" action="/view/recipes" method="get">
            <div class="input-group mb-3 px-5">
              <input
                type="text"
                class="form-control"
                placeholder="ê²€ìƒ‰í•˜ê³  ì‹¶ì€ ë ˆì‹œí”¼ ì œëª©ì„ ì‘ì„±í•˜ì„¸ìš”."
                name="q"
              />
              <button
                class="btn btn btn-outline-success"
                type="submit"
                id="search-button"
              >
                ğŸ” ê²€ìƒ‰í•˜ê¸°
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="row justify-content-center">
        <ul
          class="nav nav-fill mt-3 col-sm-10 col-lg-6"
          id="recipetory-menu"
        ></ul>
      </div>
    </header>
    <div class="justify-content-center px-3 mb-5">
      <section class="container my-3">
        <div class="row justify-content-center">
          <div class="col-md-8 col-lg-6">
            <h1 class="text-center my-3">âœï¸ ë ˆì‹œí”¼ ì‘ì„±</h1>
            <div class="card">
              <div class="card-body">
                <form id="recipe-form" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label for="recipe-title" class="mb-1 fw-bold"
                      ><h4>ğŸ“š ë ˆì‹œí”¼ ì œëª©</h4></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="recipe-title"
                      name="title"
                      placeholder="ë ˆì‹œí”¼ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ex. ë§›ìˆëŠ” ì‹œê¸ˆì¹˜ íŒŒìŠ¤íƒ€)"
                      required
                    />
                  </div>

                  <div class="mb-3">
                    <label for="recipe-description mb-1" class="mb-1 fw-bold"
                      ><h4>ğŸ“ƒ ë ˆì‹œí”¼ ì„¤ëª…</h4></label
                    >
                    <textarea
                      class="form-control"
                      id="recipe-description"
                      name="description"
                      rows="3"
                      placeholder="1000ì ì´ë‚´ì˜ ë ˆì‹œí”¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ex. ì‹œê¸ˆì¹˜ì˜ í–¥ê³¼ ì‹ê°ì„ ì¦ê¸¸ ìˆ˜ ìˆëŠ” íŒŒìŠ¤íƒ€ì…ë‹ˆë‹¤. ê°„í¸í•˜ê²Œ í•´ë¨¹ê¸° ì¢‹ì•„ìš”.)"
                      required
                    ></textarea>
                  </div>

                  <div class="mb-3">
                    <label for="cookingTime" class="fw-bold"
                      ><h4>â° ì†Œìš” ì‹œê°„</h4></label
                    >
                    <select
                      class="form-select"
                      id="cookingTime"
                      name="cookingTime"
                    >
                      <option value="UNDEFINED">ì„ íƒì•ˆí•¨</option>
                      <option value="LESS_THAN_10">10ë¶„ ì´ë‚´</option>
                      <option value="LESS_THAN_20">20ë¶„ ì´ë‚´</option>
                      <option value="LESS_THAN_30">30ë¶„ ì´ë‚´</option>
                      <option value="LESS_THAN_60">1ì‹œê°„ ì´ë‚´</option>
                      <option value="LESS_THAN_90">1ì‹œê°„ 30ë¶„ ì´ë‚´</option>
                      <option value="LESS_THAN_120">2ì‹œê°„ ì´ë‚´</option>
                      <option value="MORE_THAN_120">2ì‹œê°„ ì´ìƒ</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="difficulty" class="fw-bold"
                      ><h4>â“ ë‚œì´ë„</h4></label
                    >
                    <select
                      class="form-select"
                      id="difficulty"
                      name="difficulty"
                    >
                      <option value="UNDEFINED">ì„ íƒì•ˆí•¨</option>
                      <option value="EASY">ì‰¬ì›€</option>
                      <option value="NORMAL">ë³´í†µ</option>
                      <option value="HARD">ì–´ë ¤ì›€</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="serving" class="fw-bold"
                      ><h4>ğŸ‘©â€ğŸ‘§ ë¶„ëŸ‰</h4></label
                    >
                    <select class="form-select" id="serving" name="serving">
                      <option value="UNDEFINED">ì„ íƒì•ˆí•¨</option>
                      <option value="ONE">1ì¸ë¶„</option>
                      <option value="TWO">2ì¸ë¶„</option>
                      <option value="THREE">3ì¸ë¶„</option>
                      <option value="FOUR">4ì¸ë¶„</option>
                      <option value="MORE">5ì¸ë¶„ ì´ìƒ</option>
                    </select>
                  </div>

                  <div class="mb-1">
                    <label for="recipe-steps" class="mb-1 fw-bold"
                      ><h4>ğŸ´ ë‹¨ê³„</h4></label
                    >
                    <div id="step-input">
                      <textarea
                        class="form-control mb-2"
                        name="steps[]"
                        rows="2"
                        placeholder="ì¡°ë¦¬ ê³¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ex. ë¬¼ 2ë¦¬í„°ì— ì†Œê¸ˆì„ ì¡°ê¸ˆ ë„£ê³  ë“ì´ê³ , ì‹œê¸ˆì¹˜ëŠ” ë¿Œë¦¬ ë¶€ë¶„ì„ ì˜ë¼ ì¤€ë¹„í•©ë‹ˆë‹¤.)"
                        required
                      ></textarea>
                    </div>
                    <div
                      class="d-flex justify-content-between align-items-center mt-2"
                    >
                      <div class="ms-auto">
                        <button
                          type="button"
                          class="btn btn-outline-success btn-sm"
                          onclick="addStepForm()"
                        >
                          ë‹¨ê³„ ì¶”ê°€
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-danger btn-sm"
                          onclick="deleteStepForm()"
                        >
                          ë‹¨ê³„ ì‚­ì œ
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="recipe-steps" class="mb-1 fw-bold"
                      ><h4>ğŸ¥” ì¬ë£Œ</h4></label
                    >
                    <div id="ingredient-input">
                      <div class="input-group mb-1">
                        <input
                          type="text"
                          name="ingredientName[]"
                          class="form-control"
                          placeholder="ì¬ë£Œ ì´ë¦„ (ex. íŒŒìŠ¤íƒ€ ë©´)"
                          required
                        />
                        <input
                          type="text"
                          name="ingredientAmount[]"
                          class="form-control"
                          placeholder="ì¬ë£Œ ë¶„ëŸ‰ (ex. 100g)"
                          required
                        />
                      </div>
                    </div>
                    <div
                      class="d-flex justify-content-between align-items-center mt-2"
                    >
                      <div class="ms-auto">
                        <button
                          type="button"
                          class="btn btn-outline-success btn-sm"
                          onclick="addIngredientForm()"
                        >
                          ì¬ë£Œ ì¶”ê°€
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-danger btn-sm"
                          onclick="deleteIngredientForm()"
                        >
                          ì¬ë£Œ ì‚­ì œ
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <div class="d-flex align-items-center mb-3">
                      <h4 class="fw-bold">ğŸ·ï¸ íƒœê·¸</h4>
                      <span class="ms-3"
                        >í•´ë‹¹í•˜ëŠ” íƒœê·¸ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</span
                      >
                    </div>
                    <div class="row d-flex" id="tag-input"></div>
                  </div>

                  <div class="d-flex mt-5">
                    <button
                      type="submit"
                      class="btn btn-success btn-lg mx-auto"
                    >
                      ì‘ì„± ì™„ë£Œ
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer class="text-center py-4 mt-auto" style="background-color: #d1e7dc">
      <p>&copy; 2023 Recipetory</p>
      <p>
        <a href="https://github.com/f-lab-edu/recipetory" style="color: #0c432a"
          >BuchuKim</a
        >
      </p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
    <script src="/view/js/build-menu.js"></script>
    <script src="/view/js/build-tag.js"></script>
    <script>
      (() => {
        "use strict";

        const forms = document.querySelectorAll(".needs-validation");

        Array.from(forms).forEach((form) => {
          form.addEventListener(
            "submit",
            (event) => {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                alert("í•„ìš”í•œ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
              }

              form.classList.add("was-validated");
            },
            true
          );
        });
      })();
    </script>
    <script>
      getAllTags().then((tags) => {
        const tagDiv = document.querySelector("#tag-input");
        tags.forEach((tag) => {
          const tagElement = document.createElement("div");
          tagElement.classList.add(
            "col-4",
            "d-flex",
            "justify-content-center",
            "mb-2"
          );
          tagElement.innerHTML = `
                  <input
                    type="checkbox"
                    class="btn-check"
                    name="tags[]"
                    id="${tag.name}"
                    value="${tag.name}"
                    autocomplete="off"
                  />
                  <label class="btn btn-outline-dark" for="${tag.name}">#${tag.description}</label>
          `;
          tagDiv.appendChild(tagElement);
        });
      });

      // recipe post
      const recipeForm = document.querySelector("#recipe-form");
      recipeForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const jsonData = {};

        jsonData["title"] = formData.get("title");
        jsonData["description"] = formData.get("description");
        jsonData["cookingTime"] = formData.get("cookingTime");
        jsonData["difficulty"] = formData.get("difficulty");
        jsonData["serving"] = formData.get("serving");

        jsonData["steps"] = [];
        const steps = formData.getAll("steps[]");
        for (let i = 0; i < steps.length; i++) {
          const step = { stepNumber: i, description: steps[i] };
          jsonData["steps"].push(step);
        }

        jsonData["ingredients"] = [];
        const ingredientNames = formData.getAll("ingredientName[]");
        const ingredientAmounts = formData.getAll("ingredientAmount[]");
        for (let i = 0; i < ingredientNames.length; i++) {
          const ingredient = {
            name: ingredientNames[i],
            amount: ingredientAmounts[i],
          };
          jsonData["ingredients"].push(ingredient);
        }

        jsonData["tags"] = [];
        const tags = formData.getAll("tags[]");
        for (let i = 0; i < tags.length; i++) {
          jsonData["tags"].push({ tagName: tags[i] });
        }

        axios
          .post("/recipes", jsonData)
          .then((response) => {
            const created = response.data;
            window.location.href = "/";
          })
          .catch((error) => {
            if (error.response.status === 401) {
              alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
              window.location.href = "/view/login";
            } else {
              console.log("error! : ", error);
              alert(error);
            }
          });
      });

      function addIngredientForm() {
        const ingredientDiv = document.querySelector("#ingredient-input");
        const ingredientField = document.createElement("div");
        ingredientField.classList.add("input-group", "mb-1");
        ingredientField.innerHTML = `
                        <input
                          type="text"
                          name="ingredientName[]"
                          class="form-control"
                          placeholder="ì¬ë£Œ ì´ë¦„"
                          required
                        />
                        <input
                          type="text"
                          name="ingredientAmount[]"
                          class="form-control"
                          placeholder="ì¬ë£Œ ë¶„ëŸ‰"
                          required
                        />
            `;
        ingredientDiv.appendChild(ingredientField);
      }

      function deleteIngredientForm() {
        const ingredientDiv = document.querySelector("#ingredient-input");
        if (ingredientDiv.childElementCount >= 2) {
          const lastChild = ingredientDiv.lastElementChild;
          ingredientDiv.removeChild(lastChild);
        } else {
          alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        }
      }

      function addStepForm() {
        const stepDiv = document.querySelector("#step-input");
        const stepForm = document.createElement("textarea");
        stepForm.classList.add("form-control", "mb-2");
        stepForm.setAttribute("name", "steps[]");
        stepForm.setAttribute("rows", "2");
        stepForm.required = true;
        stepForm.setAttribute("placeholder", "ì¡°ë¦¬ ê³¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        stepDiv.appendChild(stepForm);
      }

      function deleteStepForm() {
        const stepDiv = document.querySelector("#step-input");
        if (stepDiv.childElementCount >= 2) {
          const lastChild = stepDiv.lastElementChild;
          stepDiv.removeChild(lastChild);
        } else {
          alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¡°ë¦¬ ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        }
      }
    </script>
  </body>
</html>
